import { Directive, Inject, Input, Optional, Self } from '@angular/core';
import { EMPTY, fromEvent, merge, NEVER, Subject } from 'rxjs';
import { distinctUntilChanged, mapTo, startWith, switchMap, takeUntil } from 'rxjs/operators';
import { DefaultControlErrorComponent } from './control-error.component';
import { ErrorTailorConfigProvider, FORM_ERRORS } from './providers';
import * as i0 from "@angular/core";
import * as i1 from "./control-error-anchor.directive";
import * as i2 from "./form-action.directive";
import * as i3 from "@angular/forms";
export class ControlErrorsDirective {
    constructor(vcr, host, config, globalErrors, controlErrorAnchorParent, form, ngControl, controlContainer) {
        this.vcr = vcr;
        this.host = host;
        this.config = config;
        this.globalErrors = globalErrors;
        this.controlErrorAnchorParent = controlErrorAnchorParent;
        this.form = form;
        this.ngControl = ngControl;
        this.controlContainer = controlContainer;
        this.customErrors = {};
        this.destroy = new Subject();
        this.showError$ = new Subject();
        this.mergedConfig = {};
        this.submit$ = this.form ? this.form.submit$ : EMPTY;
        this.reset$ = this.form ? this.form.reset$ : EMPTY;
    }
    ngOnInit() {
        this.mergedConfig = this.buildConfig();
        this.anchor = this.resolveAnchor();
        this.control = (this.controlContainer || this.ngControl).control;
        const hasAsyncValidator = !!this.control.asyncValidator;
        const statusChanges$ = this.control.statusChanges.pipe(distinctUntilChanged());
        const valueChanges$ = this.control.valueChanges;
        const controlChanges$ = merge(statusChanges$, valueChanges$);
        let changesOnAsync$ = EMPTY;
        let changesOnBlur$ = EMPTY;
        let changesOnChange$ = EMPTY;
        if (!this.controlErrorsClass || this.controlErrorsClass?.length === 0) {
            if (this.mergedConfig.controlErrorsClass && this.mergedConfig.controlErrorsClass) {
                this.controlErrorsClass = this.mergedConfig.controlErrorsClass;
            }
        }
        if (!this.controlCustomClass || this.controlCustomClass?.length === 0) {
            if (this.mergedConfig.controlCustomClass && this.mergedConfig.controlCustomClass) {
                this.controlCustomClass = this.mergedConfig.controlCustomClass;
            }
        }
        if (this.mergedConfig.controlErrorsOn.async && hasAsyncValidator) {
            // hasAsyncThenUponStatusChange
            changesOnAsync$ = statusChanges$;
        }
        if (this.isInput && this.mergedConfig.controlErrorsOn.change) {
            // on each change
            changesOnChange$ = valueChanges$;
        }
        if (this.isInput && this.mergedConfig.controlErrorsOn.blur) {
            const blur$ = fromEvent(this.host.nativeElement, 'focusout');
            // blurFirstThenUponChange
            changesOnBlur$ = blur$.pipe(switchMap(() => valueChanges$.pipe(startWith(true))));
        }
        const submit$ = merge(this.submit$.pipe(mapTo(true)), this.reset$.pipe(mapTo(false)));
        // when submitted, submitFirstThenUponChanges
        const changesOnSubmit$ = submit$.pipe(switchMap(submit => (submit ? controlChanges$.pipe(startWith(true)) : NEVER)));
        // on reset, clear ComponentRef and customAnchorDestroyFn
        this.reset$.pipe(takeUntil(this.destroy)).subscribe(() => this.clearRefs());
        merge(changesOnAsync$, changesOnBlur$, changesOnChange$, changesOnSubmit$, this.showError$)
            .pipe(takeUntil(this.destroy))
            .subscribe(() => this.valueChanges());
    }
    setError(text, error) {
        if (!this.ref) {
            this.ref = this.anchor.createComponent(this.mergedConfig.controlErrorComponent);
        }
        const instance = this.ref.instance;
        if (this.controlErrorsTpl) {
            instance.createTemplate(this.controlErrorsTpl, error, text);
        }
        else {
            instance.text = text;
        }
        if (this.controlErrorsClass) {
            instance.customClass = this.controlErrorsClass;
        }
        if (!this.controlErrorAnchor && this.mergedConfig.controlErrorComponentAnchorFn) {
            this.customAnchorDestroyFn = this.mergedConfig.controlErrorComponentAnchorFn(this.host.nativeElement, this.ref.hostView.rootNodes[0]);
        }
    }
    /**
     * Explicit showing of a control error via some custom application code.
     */
    showError() {
        this.showError$.next();
    }
    /**
     * Explicit hiding of a control error via some custom application code.
     */
    hideError() {
        this.setError(null);
    }
    ngOnDestroy() {
        this.destroy.next();
        this.clearRefs();
    }
    get isInput() {
        return this.mergedConfig.blurPredicate(this.host.nativeElement);
    }
    clearRefs() {
        if (this.customAnchorDestroyFn) {
            this.customAnchorDestroyFn();
            this.customAnchorDestroyFn = null;
        }
        if (this.ref) {
            this.ref.destroy();
        }
        this.ref = null;
    }
    valueChanges() {
        const controlErrors = this.control.errors;
        const classesAdd = Array.isArray(this.controlCustomClass)
            ? this.controlCustomClass
            : this.controlCustomClass?.split(/\s/) ?? [];
        if (controlErrors) {
            const [firstKey] = Object.keys(controlErrors);
            const getError = this.customErrors[firstKey] || this.globalErrors[firstKey];
            if (!getError) {
                return;
            }
            const text = typeof getError === 'function' ? getError(controlErrors[firstKey]) : getError;
            if (this.isInput) {
                this.host.nativeElement.parentElement.classList.add('error-tailor-has-error');
                if (this.controlCustomClass) {
                    this.host.nativeElement.classList.add(...classesAdd);
                }
            }
            this.setError(text, controlErrors);
        }
        else if (this.ref) {
            if (this.isInput) {
                this.host.nativeElement.parentElement.classList.remove('error-tailor-has-error');
                if (this.controlCustomClass) {
                    this.host.nativeElement.classList.remove(...classesAdd);
                }
            }
            this.setError(null);
        }
    }
    resolveAnchor() {
        if (this.controlErrorAnchor) {
            return this.controlErrorAnchor.vcr;
        }
        if (this.controlErrorAnchorParent) {
            return this.controlErrorAnchorParent.vcr;
        }
        return this.vcr;
    }
    buildConfig() {
        return {
            ...{
                blurPredicate(element) {
                    return element.tagName === 'INPUT' || element.tagName === 'SELECT';
                },
                controlErrorComponent: DefaultControlErrorComponent
            },
            ...this.config,
            controlErrorsOn: {
                async: this.controlErrorsOnAsync ?? this.config.controlErrorsOn?.async ?? true,
                blur: this.controlErrorsOnBlur ?? this.config.controlErrorsOn?.blur ?? true,
                change: this.controlErrorsOnChange ?? this.config.controlErrorsOn?.change ?? false
            }
        };
    }
}
ControlErrorsDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: ControlErrorsDirective, deps: [{ token: i0.ViewContainerRef }, { token: i0.ElementRef }, { token: ErrorTailorConfigProvider }, { token: FORM_ERRORS }, { token: i1.ControlErrorAnchorDirective, optional: true }, { token: i2.FormActionDirective, optional: true }, { token: i3.NgControl, optional: true, self: true }, { token: i3.ControlContainer, optional: true, self: true }], target: i0.ɵɵFactoryTarget.Directive });
ControlErrorsDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "15.0.1", type: ControlErrorsDirective, isStandalone: true, selector: "[formControlName]:not([controlErrorsIgnore]), [formControl]:not([controlErrorsIgnore]), [formGroup]:not([controlErrorsIgnore]), [formGroupName]:not([controlErrorsIgnore]), [formArrayName]:not([controlErrorsIgnore]), [ngModel]:not([controlErrorsIgnore])", inputs: { customErrors: ["controlErrors", "customErrors"], controlErrorsClass: "controlErrorsClass", controlCustomClass: "controlCustomClass", controlErrorsTpl: "controlErrorsTpl", controlErrorsOnAsync: "controlErrorsOnAsync", controlErrorsOnBlur: "controlErrorsOnBlur", controlErrorsOnChange: "controlErrorsOnChange", controlErrorAnchor: "controlErrorAnchor" }, exportAs: ["errorTailor"], ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.1", ngImport: i0, type: ControlErrorsDirective, decorators: [{
            type: Directive,
            args: [{
                    standalone: true,
                    selector: '[formControlName]:not([controlErrorsIgnore]), [formControl]:not([controlErrorsIgnore]), [formGroup]:not([controlErrorsIgnore]), [formGroupName]:not([controlErrorsIgnore]), [formArrayName]:not([controlErrorsIgnore]), [ngModel]:not([controlErrorsIgnore])',
                    exportAs: 'errorTailor'
                }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef }, { type: i0.ElementRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [ErrorTailorConfigProvider]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [FORM_ERRORS]
                }] }, { type: i1.ControlErrorAnchorDirective, decorators: [{
                    type: Optional
                }] }, { type: i2.FormActionDirective, decorators: [{
                    type: Optional
                }] }, { type: i3.NgControl, decorators: [{
                    type: Optional
                }, {
                    type: Self
                }] }, { type: i3.ControlContainer, decorators: [{
                    type: Optional
                }, {
                    type: Self
                }] }]; }, propDecorators: { customErrors: [{
                type: Input,
                args: ['controlErrors']
            }], controlErrorsClass: [{
                type: Input
            }], controlCustomClass: [{
                type: Input
            }], controlErrorsTpl: [{
                type: Input
            }], controlErrorsOnAsync: [{
                type: Input
            }], controlErrorsOnBlur: [{
                type: Input
            }], controlErrorsOnChange: [{
                type: Input
            }], controlErrorAnchor: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJvbC1lcnJvci5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ25lYXQvZXJyb3ItdGFpbG9yL3NyYy9saWIvY29udHJvbC1lcnJvci5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLFNBQVMsRUFHVCxNQUFNLEVBQ04sS0FBSyxFQUdMLFFBQVEsRUFDUixJQUFJLEVBR0wsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0UsT0FBTyxFQUFFLG9CQUFvQixFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzlGLE9BQU8sRUFBeUIsNEJBQTRCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUVoRyxPQUFPLEVBQXFCLHlCQUF5QixFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQzs7Ozs7QUFTeEYsTUFBTSxPQUFPLHNCQUFzQjtJQW9CakMsWUFDVSxHQUFxQixFQUNyQixJQUFnQixFQUNtQixNQUF5QixFQUN2QyxZQUFZLEVBQ3JCLHdCQUFxRCxFQUNyRCxJQUF5QixFQUNqQixTQUFvQixFQUNwQixnQkFBa0M7UUFQdEQsUUFBRyxHQUFILEdBQUcsQ0FBa0I7UUFDckIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNtQixXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQUN2QyxpQkFBWSxHQUFaLFlBQVksQ0FBQTtRQUNyQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTZCO1FBQ3JELFNBQUksR0FBSixJQUFJLENBQXFCO1FBQ2pCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQTNCeEMsaUJBQVksR0FBYyxF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QUFJLENBQUMsTUFBTTtZQUVkLGVBQWUsRUFBRTtnQkFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEtBQUssSUFBSSxJQUFJO2dCQUM5RSxJQUFJLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLElBQUksSUFBSSxJQUFJO2dCQUMzRSxNQUFNLEVBQUUsSUFBSSxDQUFDLHFCQUFxQixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLE1BQU0sSUFBSSxLQUFLO2FBQ25GO1NBQ0YsQ0FBQztJQUNKLENBQUM7O21IQWhOVSxzQkFBc0IsNEVBdUJ2Qix5QkFBeUIsYUFDekIsV0FBVzt1R0F4QlYsc0JBQXNCOzJGQUF0QixzQkFBc0I7a0JBTmxDLFNBQVM7bUJBQUM7b0JBQ1QsVUFBVSxFQUFFLElBQUk7b0JBQ2hCLFFBQVEsRUFDTiw4UEFBOFA7b0JBQ2hRLFFBQVEsRUFBRSxhQUFhO2lCQUN4Qjs7MEJBd0JJLE1BQU07MkJBQUMseUJBQXlCOzswQkFDaEMsTUFBTTsyQkFBQyxXQUFXOzswQkFDbEIsUUFBUTs7MEJBQ1IsUUFBUTs7MEJBQ1IsUUFBUTs7MEJBQUksSUFBSTs7MEJBQ2hCLFFBQVE7OzBCQUFJLElBQUk7NENBM0JLLFlBQVk7c0JBQW5DLEtBQUs7dUJBQUMsZUFBZTtnQkFDYixrQkFBa0I7c0JBQTFCLEtBQUs7Z0JBQ0csa0JBQWtCO3NCQUExQixLQUFLO2dCQUNHLGdCQUFnQjtzQkFBeEIsS0FBSztnQkFDRyxvQkFBb0I7c0JBQTVCLEtBQUs7Z0JBQ0csbUJBQW1CO3NCQUEzQixLQUFLO2dCQUNHLHFCQUFxQjtzQkFBN0IsS0FBSztnQkFDRyxrQkFBa0I7c0JBQTFCLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnRSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgRW1iZWRkZWRWaWV3UmVmLFxuICBJbmplY3QsXG4gIElucHV0LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3B0aW9uYWwsXG4gIFNlbGYsXG4gIFRlbXBsYXRlUmVmLFxuICBWaWV3Q29udGFpbmVyUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBDb250cm9sQ29udGFpbmVyLCBOZ0NvbnRyb2wsIFZhbGlkYXRpb25FcnJvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBFTVBUWSwgZnJvbUV2ZW50LCBtZXJnZSwgTkVWRVIsIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXBUbywgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgQ29udHJvbEVycm9yQW5jaG9yRGlyZWN0aXZlIH0gZnJvbSAnLi9jb250cm9sLWVycm9yLWFuY2hvci5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgQ29udHJvbEVycm9yQ29tcG9uZW50LCBEZWZhdWx0Q29udHJvbEVycm9yQ29tcG9uZW50IH0gZnJvbSAnLi9jb250cm9sLWVycm9yLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBGb3JtQWN0aW9uRGlyZWN0aXZlIH0gZnJvbSAnLi9mb3JtLWFjdGlvbi5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgRXJyb3JUYWlsb3JDb25maWcsIEVycm9yVGFpbG9yQ29uZmlnUHJvdmlkZXIsIEZPUk1fRVJST1JTIH0gZnJvbSAnLi9wcm92aWRlcnMnO1xuaW1wb3J0IHsgRXJyb3JzTWFwIH0gZnJvbSAnLi90eXBlcyc7XG5cbkBEaXJlY3RpdmUoe1xuICBzdGFuZGFsb25lOiB0cnVlLFxuICBzZWxlY3RvcjpcbiAgICAnW2Zvcm1Db250cm9sTmFtZV06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSksIFtmb3JtQ29udHJvbF06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSksIFtmb3JtR3JvdXBdOm5vdChbY29udHJvbEVycm9yc0lnbm9yZV0pLCBbZm9ybUdyb3VwTmFtZV06bm90KFtjb250cm9sRXJyb3JzSWdub3JlXSksIFtmb3JtQXJyYXlOYW1lXTpub3QoW2NvbnRyb2xFcnJvcnNJZ25vcmVdKSwgW25nTW9kZWxdOm5vdChbY29udHJvbEVycm9yc0lnbm9yZV0pJyxcbiAgZXhwb3J0QXM6ICdlcnJvclRhaWxvcidcbn0pXG5leHBvcnQgY2xhc3MgQ29udHJvbEVycm9yc0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgQElucHV0KCdjb250cm9sRXJyb3JzJykgY3VzdG9tRXJyb3JzOiBFcnJvcnNNYXAgPSB7fTtcbiAgQElucHV0KCkgY29udHJvbEVycm9yc0NsYXNzOiBzdHJpbmcgfCBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgQElucHV0KCkgY29udHJvbEN1c3RvbUNsYXNzOiBzdHJpbmcgfCBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgQElucHV0KCkgY29udHJvbEVycm9yc1RwbDogVGVtcGxhdGVSZWY8YW55PiB8IHVuZGVmaW5lZDtcbiAgQElucHV0KCkgY29udHJvbEVycm9yc09uQXN5bmM6IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG4gIEBJbnB1dCgpIGNvbnRyb2xFcnJvcnNPbkJsdXI6IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG4gIEBJbnB1dCgpIGNvbnRyb2xFcnJvcnNPbkNoYW5nZTogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgQElucHV0KCkgY29udHJvbEVycm9yQW5jaG9yOiBDb250cm9sRXJyb3JBbmNob3JEaXJlY3RpdmU7XG5cbiAgcHJpdmF0ZSByZWY6IENvbXBvbmVudFJlZjxDb250cm9sRXJyb3JDb21wb25lbnQ+O1xuICBwcml2YXRlIGFuY2hvcjogVmlld0NvbnRhaW5lclJlZjtcbiAgcHJpdmF0ZSBzdWJtaXQkOiBPYnNlcnZhYmxlPEV2ZW50PjtcbiAgcHJpdmF0ZSByZXNldCQ6IE9ic2VydmFibGU8RXZlbnQ+O1xuICBwcml2YXRlIGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbDtcbiAgcHJpdmF0ZSBkZXN0cm95ID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBzaG93RXJyb3IkID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBtZXJnZWRDb25maWc6IEVycm9yVGFpbG9yQ29uZmlnID0ge307XG4gIHByaXZhdGUgY3VzdG9tQW5jaG9yRGVzdHJveUZuOiAoKSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdmNyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByaXZhdGUgaG9zdDogRWxlbWVudFJlZixcbiAgICBASW5qZWN0KEVycm9yVGFpbG9yQ29uZmlnUHJvdmlkZXIpIHByaXZhdGUgY29uZmlnOiBFcnJvclRhaWxvckNvbmZpZyxcbiAgICBASW5qZWN0KEZPUk1fRVJST1JTKSBwcml2YXRlIGdsb2JhbEVycm9ycyxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGNvbnRyb2xFcnJvckFuY2hvclBhcmVudDogQ29udHJvbEVycm9yQW5jaG9yRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZm9ybTogRm9ybUFjdGlvbkRpcmVjdGl2ZSxcbiAgICBAT3B0aW9uYWwoKSBAU2VsZigpIHByaXZhdGUgbmdDb250cm9sOiBOZ0NvbnRyb2wsXG4gICAgQE9wdGlvbmFsKCkgQFNlbGYoKSBwcml2YXRlIGNvbnRyb2xDb250YWluZXI6IENvbnRyb2xDb250YWluZXJcbiAgKSB7XG4gICAgdGhpcy5zdWJtaXQkID0gdGhpcy5mb3JtID8gdGhpcy5mb3JtLnN1Ym1pdCQgOiBFTVBUWTtcbiAgICB0aGlzLnJlc2V0JCA9IHRoaXMuZm9ybSA/IHRoaXMuZm9ybS5yZXNldCQgOiBFTVBUWTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMubWVyZ2VkQ29uZmlnID0gdGhpcy5idWlsZENvbmZpZygpO1xuXG4gICAgdGhpcy5hbmNob3IgPSB0aGlzLnJlc29sdmVBbmNob3IoKTtcbiAgICB0aGlzLmNvbnRyb2wgPSAodGhpcy5jb250cm9sQ29udGFpbmVyIHx8IHRoaXMubmdDb250cm9sKS5jb250cm9sO1xuICAgIGNvbnN0IGhhc0FzeW5jVmFsaWRhdG9yID0gISF0aGlzLmNvbnRyb2wuYXN5bmNWYWxpZGF0b3I7XG5cbiAgICBjb25zdCBzdGF0dXNDaGFuZ2VzJCA9IHRoaXMuY29udHJvbC5zdGF0dXNDaGFuZ2VzLnBpcGUoZGlzdGluY3RVbnRpbENoYW5nZWQoKSk7XG4gICAgY29uc3QgdmFsdWVDaGFuZ2VzJCA9IHRoaXMuY29udHJvbC52YWx1ZUNoYW5nZXM7XG4gICAgY29uc3QgY29udHJvbENoYW5nZXMkID0gbWVyZ2Uoc3RhdHVzQ2hhbmdlcyQsIHZhbHVlQ2hhbmdlcyQpO1xuICAgIGxldCBjaGFuZ2VzT25Bc3luYyQ6IE9ic2VydmFibGU8YW55PiA9IEVNUFRZO1xuICAgIGxldCBjaGFuZ2VzT25CbHVyJDogT2JzZXJ2YWJsZTxhbnk+ID0gRU1QVFk7XG4gICAgbGV0IGNoYW5nZXNPbkNoYW5nZSQ6IE9ic2VydmFibGU8YW55PiA9IEVNUFRZO1xuXG4gICAgaWYgKCF0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcyB8fCB0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcz8ubGVuZ3RoID09PSAwKSB7XG4gICAgICBpZiAodGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yc0NsYXNzICYmIHRoaXMubWVyZ2VkQ29uZmlnLmNvbnRyb2xFcnJvcnNDbGFzcykge1xuICAgICAgICB0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcyA9IHRoaXMubWVyZ2VkQ29uZmlnLmNvbnRyb2xFcnJvcnNDbGFzcztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuY29udHJvbEN1c3RvbUNsYXNzIHx8IHRoaXMuY29udHJvbEN1c3RvbUNsYXNzPy5sZW5ndGggPT09IDApIHtcbiAgICAgIGlmICh0aGlzLm1lcmdlZENvbmZpZy5jb250cm9sQ3VzdG9tQ2xhc3MgJiYgdGhpcy5tZXJnZWRDb25maWcuY29udHJvbEN1c3RvbUNsYXNzKSB7XG4gICAgICAgIHRoaXMuY29udHJvbEN1c3RvbUNsYXNzID0gdGhpcy5tZXJnZWRDb25maWcuY29udHJvbEN1c3RvbUNsYXNzO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLm1lcmdlZENvbmZpZy5jb250cm9sRXJyb3JzT24uYXN5bmMgJiYgaGFzQXN5bmNWYWxpZGF0b3IpIHtcbiAgICAgIC8vIGhhc0FzeW5jVGhlblVwb25TdGF0dXNDaGFuZ2VcbiAgICAgIGNoYW5nZXNPbkFzeW5jJCA9IHN0YXR1c0NoYW5nZXMkO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzSW5wdXQgJiYgdGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yc09uLmNoYW5nZSkge1xuICAgICAgLy8gb24gZWFjaCBjaGFuZ2VcbiAgICAgIGNoYW5nZXNPbkNoYW5nZSQgPSB2YWx1ZUNoYW5nZXMkO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzSW5wdXQgJiYgdGhpcy5tZXJnZWRDb25maWcuY29udHJvbEVycm9yc09uLmJsdXIpIHtcbiAgICAgIGNvbnN0IGJsdXIkID0gZnJvbUV2ZW50KHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50LCAnZm9jdXNvdXQnKTtcbiAgICAgIC8vIGJsdXJGaXJzdFRoZW5VcG9uQ2hhbmdlXG4gICAgICBjaGFuZ2VzT25CbHVyJCA9IGJsdXIkLnBpcGUoc3dpdGNoTWFwKCgpID0+IHZhbHVlQ2hhbmdlcyQucGlwZShzdGFydFdpdGgodHJ1ZSkpKSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3VibWl0JCA9IG1lcmdlKHRoaXMuc3VibWl0JC5waXBlKG1hcFRvKHRydWUpKSwgdGhpcy5yZXNldCQucGlwZShtYXBUbyhmYWxzZSkpKTtcblxuICAgIC8vIHdoZW4gc3VibWl0dGVkLCBzdWJtaXRGaXJzdFRoZW5VcG9uQ2hhbmdlc1xuICAgIGNvbnN0IGNoYW5nZXNPblN1Ym1pdCQgPSBzdWJtaXQkLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoc3VibWl0ID0+IChzdWJtaXQgPyBjb250cm9sQ2hhbmdlcyQucGlwZShzdGFydFdpdGgodHJ1ZSkpIDogTkVWRVIpKVxuICAgICk7XG5cbiAgICAvLyBvbiByZXNldCwgY2xlYXIgQ29tcG9uZW50UmVmIGFuZCBjdXN0b21BbmNob3JEZXN0cm95Rm5cbiAgICB0aGlzLnJlc2V0JC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kpKS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5jbGVhclJlZnMoKSk7XG5cbiAgICBtZXJnZShjaGFuZ2VzT25Bc3luYyQsIGNoYW5nZXNPbkJsdXIkLCBjaGFuZ2VzT25DaGFuZ2UkLCBjaGFuZ2VzT25TdWJtaXQkLCB0aGlzLnNob3dFcnJvciQpXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95KSlcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4gdGhpcy52YWx1ZUNoYW5nZXMoKSk7XG4gIH1cblxuICBwcml2YXRlIHNldEVycm9yKHRleHQ6IHN0cmluZywgZXJyb3I/OiBWYWxpZGF0aW9uRXJyb3JzKSB7XG4gICAgaWYgKCF0aGlzLnJlZikge1xuICAgICAgdGhpcy5yZWYgPSB0aGlzLmFuY2hvci5jcmVhdGVDb21wb25lbnQ8Q29udHJvbEVycm9yQ29tcG9uZW50Pih0aGlzLm1lcmdlZENvbmZpZy5jb250cm9sRXJyb3JDb21wb25lbnQpO1xuICAgIH1cbiAgICBjb25zdCBpbnN0YW5jZSA9IHRoaXMucmVmLmluc3RhbmNlO1xuXG4gICAgaWYgKHRoaXMuY29udHJvbEVycm9yc1RwbCkge1xuICAgICAgaW5zdGFuY2UuY3JlYXRlVGVtcGxhdGUodGhpcy5jb250cm9sRXJyb3JzVHBsLCBlcnJvciwgdGV4dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluc3RhbmNlLnRleHQgPSB0ZXh0O1xuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcykge1xuICAgICAgaW5zdGFuY2UuY3VzdG9tQ2xhc3MgPSB0aGlzLmNvbnRyb2xFcnJvcnNDbGFzcztcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuY29udHJvbEVycm9yQW5jaG9yICYmIHRoaXMubWVyZ2VkQ29uZmlnLmNvbnRyb2xFcnJvckNvbXBvbmVudEFuY2hvckZuKSB7XG4gICAgICB0aGlzLmN1c3RvbUFuY2hvckRlc3Ryb3lGbiA9IHRoaXMubWVyZ2VkQ29uZmlnLmNvbnRyb2xFcnJvckNvbXBvbmVudEFuY2hvckZuKFxuICAgICAgICB0aGlzLmhvc3QubmF0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudCxcbiAgICAgICAgKHRoaXMucmVmLmhvc3RWaWV3IGFzIEVtYmVkZGVkVmlld1JlZjxhbnk+KS5yb290Tm9kZXNbMF0gYXMgSFRNTEVsZW1lbnRcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEV4cGxpY2l0IHNob3dpbmcgb2YgYSBjb250cm9sIGVycm9yIHZpYSBzb21lIGN1c3RvbSBhcHBsaWNhdGlvbiBjb2RlLlxuICAgKi9cbiAgc2hvd0Vycm9yKCk6IHZvaWQge1xuICAgIHRoaXMuc2hvd0Vycm9yJC5uZXh0KCk7XG4gIH1cblxuICAvKipcbiAgICogRXhwbGljaXQgaGlkaW5nIG9mIGEgY29udHJvbCBlcnJvciB2aWEgc29tZSBjdXN0b20gYXBwbGljYXRpb24gY29kZS5cbiAgICovXG4gIGhpZGVFcnJvcigpOiB2b2lkIHtcbiAgICB0aGlzLnNldEVycm9yKG51bGwpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95Lm5leHQoKTtcbiAgICB0aGlzLmNsZWFyUmVmcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgaXNJbnB1dCgpIHtcbiAgICByZXR1cm4gdGhpcy5tZXJnZWRDb25maWcuYmx1clByZWRpY2F0ZSh0aGlzLmhvc3QubmF0aXZlRWxlbWVudCk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFyUmVmcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jdXN0b21BbmNob3JEZXN0cm95Rm4pIHtcbiAgICAgIHRoaXMuY3VzdG9tQW5jaG9yRGVzdHJveUZuKCk7XG4gICAgICB0aGlzLmN1c3RvbUFuY2hvckRlc3Ryb3lGbiA9IG51bGw7XG4gICAgfVxuICAgIGlmICh0aGlzLnJlZikge1xuICAgICAgdGhpcy5yZWYuZGVzdHJveSgpO1xuICAgIH1cbiAgICB0aGlzLnJlZiA9IG51bGw7XG4gIH1cblxuICBwcml2YXRlIHZhbHVlQ2hhbmdlcygpIHtcbiAgICBjb25zdCBjb250cm9sRXJyb3JzID0gdGhpcy5jb250cm9sLmVycm9ycztcbiAgICBjb25zdCBjbGFzc2VzQWRkID0gQXJyYXkuaXNBcnJheSh0aGlzLmNvbnRyb2xDdXN0b21DbGFzcylcbiAgICAgID8gdGhpcy5jb250cm9sQ3VzdG9tQ2xhc3NcbiAgICAgIDogdGhpcy5jb250cm9sQ3VzdG9tQ2xhc3M/LnNwbGl0KC9cXHMvKSA/PyBbXTtcbiAgICBpZiAoY29udHJvbEVycm9ycykge1xuICAgICAgY29uc3QgW2ZpcnN0S2V5XSA9IE9iamVjdC5rZXlzKGNvbnRyb2xFcnJvcnMpO1xuICAgICAgY29uc3QgZ2V0RXJyb3IgPSB0aGlzLmN1c3RvbUVycm9yc1tmaXJzdEtleV0gfHwgdGhpcy5nbG9iYWxFcnJvcnNbZmlyc3RLZXldO1xuICAgICAgaWYgKCFnZXRFcnJvcikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRleHQgPSB0eXBlb2YgZ2V0RXJyb3IgPT09ICdmdW5jdGlvbicgPyBnZXRFcnJvcihjb250cm9sRXJyb3JzW2ZpcnN0S2V5XSkgOiBnZXRFcnJvcjtcbiAgICAgIGlmICh0aGlzLmlzSW5wdXQpIHtcbiAgICAgICAgdGhpcy5ob3N0Lm5hdGl2ZUVsZW1lbnQucGFyZW50RWxlbWVudC5jbGFzc0xpc3QuYWRkKCdlcnJvci10YWlsb3ItaGFzLWVycm9yJyk7XG4gICAgICAgIGlmICh0aGlzLmNvbnRyb2xDdXN0b21DbGFzcykge1xuICAgICAgICAgICh0aGlzLmhvc3QubmF0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudCkuY2xhc3NMaXN0LmFkZCguLi5jbGFzc2VzQWRkKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5zZXRFcnJvcih0ZXh0LCBjb250cm9sRXJyb3JzKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMucmVmKSB7XG4gICAgICBpZiAodGhpcy5pc0lucHV0KSB7XG4gICAgICAgIHRoaXMuaG9zdC5uYXRpdmVFbGVtZW50LnBhcmVudEVsZW1lbnQuY2xhc3NMaXN0LnJlbW92ZSgnZXJyb3ItdGFpbG9yLWhhcy1lcnJvcicpO1xuICAgICAgICBpZiAodGhpcy5jb250cm9sQ3VzdG9tQ2xhc3MpIHtcbiAgICAgICAgICAodGhpcy5ob3N0Lm5hdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQpLmNsYXNzTGlzdC5yZW1vdmUoLi4uY2xhc3Nlc0FkZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0RXJyb3IobnVsbCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXNvbHZlQW5jaG9yKCkge1xuICAgIGlmICh0aGlzLmNvbnRyb2xFcnJvckFuY2hvcikge1xuICAgICAgcmV0dXJuIHRoaXMuY29udHJvbEVycm9yQW5jaG9yLnZjcjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb250cm9sRXJyb3JBbmNob3JQYXJlbnQpIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbnRyb2xFcnJvckFuY2hvclBhcmVudC52Y3I7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnZjcjtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRDb25maWcoKTogRXJyb3JUYWlsb3JDb25maWcge1xuICAgIHJldHVybiB7XG4gICAgICAuLi57XG4gICAgICAgIGJsdXJQcmVkaWNhdGUoZWxlbWVudCkge1xuICAgICAgICAgIHJldHVybiBlbGVtZW50LnRhZ05hbWUgPT09ICdJTlBVVCcgfHwgZWxlbWVudC50YWdOYW1lID09PSAnU0VMRUNUJztcbiAgICAgICAgfSxcbiAgICAgICAgY29udHJvbEVycm9yQ29tcG9uZW50OiBEZWZhdWx0Q29udHJvbEVycm9yQ29tcG9uZW50XG4gICAgICB9LFxuXG4gICAgICAuLi50aGlzLmNvbmZpZyxcblxuICAgICAgY29udHJvbEVycm9yc09uOiB7XG4gICAgICAgIGFzeW5jOiB0aGlzLmNvbnRyb2xFcnJvcnNPbkFzeW5jID8/IHRoaXMuY29uZmlnLmNvbnRyb2xFcnJvcnNPbj8uYXN5bmMgPz8gdHJ1ZSxcbiAgICAgICAgYmx1cjogdGhpcy5jb250cm9sRXJyb3JzT25CbHVyID8/IHRoaXMuY29uZmlnLmNvbnRyb2xFcnJvcnNPbj8uYmx1ciA/PyB0cnVlLFxuICAgICAgICBjaGFuZ2U6IHRoaXMuY29udHJvbEVycm9yc09uQ2hhbmdlID8/IHRoaXMuY29uZmlnLmNvbnRyb2xFcnJvcnNPbj8uY2hhbmdlID8/IGZhbHNlXG4gICAgICB9XG4gICAgfTtcbiAgfVxufVxuIl19